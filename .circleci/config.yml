# Python CircleCI 2.0 configuration file
#
# Check https://circleci.com/docs/2.0/language-python/ for more details
version: 2

jobs:
  build:
    machine: true
    steps:
      - checkout
      - run:
          name: build docker base image
          command: docker-compose build
      - run:
          name: Run tests
          command: |
            docker-compose run --rm migrate
            docker-compose run --rm loaddata
            # docker-compose run --rm test

      - run:
          name: Push tag to github
          command: |
            if [[ "$CIRCLE_BRANCH" == 'master' ]]; then
              mkdir -p ~/.ssh
              ssh-keyscan github.com >> ~/.ssh/known_hosts
              VERSION=`awk -F\' '{print $2,$4}' main/__init__.py`
              git tag $VERSION
              git push origin $VERSION
            fi

      - run:
          name: Push image to Docker Hub
          command: |
          if [[ "$CIRCLE_BRANCH" == 'master' ]]; then
            VERSION=`awk -F\' '{print $2,$4}' main/__init__.py`
            docker login -u $DOCKER_USER -p $DOCKER_PASS
            docker tag docker-image:latest ifrcgo/go-api:$VERSION
            docker push ifrcgo/go-api:$VERSION
          fi